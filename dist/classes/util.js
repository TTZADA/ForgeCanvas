"use strict";var __importDefault=this&&this.__importDefault||function(n){return n&&n.__esModule?n:{default:n}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Logger=exports.CanvasUtil=exports.Colors=exports.hexRegex=exports.rgbaRegex=exports.fontRegex=void 0,exports.loadFrame=loadFrame,exports.parseArgs=parseArgs;const canvas_1=require("@napi-rs/canvas"),chalk_1=__importDefault(require("chalk")),__1=require(".."),gifsx_1=require("@gifsx/gifsx");exports.fontRegex=/^\s*(?=(?:(?:[-a-z]+\s*){0,2}(italic|oblique))?)(?=(?:(?:[-a-z]+\s*){0,2}(small-caps))?)(?=(?:(?:[-a-z]+\s*){0,2}(bold(?:er)?|lighter|[1-9]00))?)(?:(?:normal|\1|\2|\3)\s*){0,3}((?:xx?-)?(?:small|large)|medium|smaller|larger|[.\d]+(?:\%|in|[cem]m|ex|p[ctx]))(?:\s*\/\s*(normal|[.\d]+(?:\%|in|[cem]m|ex|p[ctx])))?\s*([-,\'\sa-z]+?)\s*$/i,exports.rgbaRegex=/^rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})(\s*,\s*(0|1|0?\.\d+))?\s*\)$/,exports.hexRegex=/^#?([0-9A-Fa-f]{3,4}){1,2}$/,exports.Colors={White:"#ffffff",Aqua:"#1abc9c",Green:"#57f287",Blue:"#3498db",Yellow:"#fee75c",Purple:"#9b59b6",LuminousVividPink:"#e91e63",Fuchsia:"#eb459e",Gold:"#f1c40f",Orange:"#e67e22",Red:"#ed4245",RubberDuck:"#FFD700",Grey:"#95a5a6",Navy:"#34495e",DarkAqua:"#11806a",DarkGreen:"#1f8b4c",DarkBlue:"#206694",DarkPurple:"#71368a",DarkVividPink:"#ad1457",DarkGold:"#c27c0e",DarkOrange:"#a84300",DarkRed:"#992d22",DarkGrey:"#979c9f",DarkerGrey:"#7f8c8d",LightGrey:"#bcc0c0",DarkNavy:"#2c3e50",Blurple:"#5865f2",Greyple:"#99aab5",DarkButNotBlack:"#2c2f33",NotQuiteBlack:"#23272a"};class CanvasUtil{static isValidFont(e){if(!e)return!1;if(exports.fontRegex.test(e)){const r=exports.fontRegex.exec(e);if(r&&r[0]){const t=r[6].split(",").map(s=>s?.trim());if(t){for(const s of t)if(!canvas_1.GlobalFonts.has(s.replace(/['',]/g,"")))return!1}return!0}return!1}return!1}static async parseStyle(e,r,t,s){if(!s)return"#000000";let i=s.split("://");if(i[0]==="gradient"){const a=r.gradientManager?.get(i.slice(1).join("://"));if(!a)return e.customError("No gradient");i=a}else if(i[0]==="pattern"){const a=i.slice(1).join("://").split(":"),l=a.shift()?.toLowerCase(),g=a.length>0&&["repeat","repeat-x","repeat-y","no-repeat"].includes(a[a.length-1])?a.pop():null;let c;if(l==="canvas"){const o=r.canvasManager?.get(g?a.join(":"):a.join())?.ctx;if(!o)return e.customError("No canvas with provided name found.");c=o.getImageData(0,0,o.canvas.width,o.canvas.height)}else if(l==="image")if(a?.join(":")?.startsWith("images://")){const o=r?.imageManager?.get(a.join(":").slice(9));if(!o)return e.customError("No image with provided name found.");c=o}else c=await(0,canvas_1.loadImage)(g?a.join(":"):a.join());else return e.customError("Invalid pattern type.");i=t.ctx.createPattern(c,g)}else i=(exports.hexRegex.test(s)?s:exports.rgbaRegex.test(s)?(()=>{const a=s.match(exports.rgbaRegex);return(0,gifsx_1.rgbaToHex)(Uint8Array.from([parseInt(a[1],10),parseInt(a[2],10),parseInt(a[3],10),a[5]?parseFloat(a[5]):255]),!1,!0)})():exports.Colors[s])??"#000000";return i}static calculateRectAlignOrBaseline(e,r,t){return t=typeof t=="string"?__1.RectAlign[t]:t,t===__1.RectAlign.center?e-r/2:t===__1.RectAlign.right||t===__1.RectBaseline.top?e-r:e}static parseFilters(e){const r=[],t=/([a-zA-Z-]+)\(([^)]+)\)/g;let s;for(;(s=t.exec(e))!==null;){const[i,a,l]=s;r.push({filter:a,value:l,raw:i})}return r}}exports.CanvasUtil=CanvasUtil,exports.Logger={DateColor:chalk_1.default.green.bold,Colors:{INFO:chalk_1.default.cyan.bold,WARN:chalk_1.default.yellow.bold,ERROR:chalk_1.default.red.bold,MESSAGE:chalk_1.default.cyan.bold},log(n,e){console.log(this.DateColor(`[${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}]`),this.Colors[n](`[${n}]`),this.Colors.MESSAGE(e))}};async function loadFrame(n,e){const r=await(0,canvas_1.loadImage)(n),t=(0,canvas_1.createCanvas)(r.width,r.height),s=t.getContext("2d");return s.drawImage(r,0,0),gifsx_1.Frame.fromRgba(t.width,t.height,Uint8Array.from(s.getImageData(0,0,t.width,t.height).data),e)}function parseArgs(n,e,r,t){const s=n.slice(typeof e=="string"?e.length:e).split(":");if(t?s.length<r:s.length!==r)throw new Error(`${e} frame expects ${r} arguments.`);return s}
