"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CanvasBuilder=void 0;const canvas_1=require("@napi-rs/canvas"),__1=require(".."),gifsx_1=require("@gifsx/gifsx");class CanvasBuilder{ctx;util=__1.CanvasUtil;customProperties={};get width(){return this.ctx.canvas.width}get height(){return this.ctx.canvas.height}set width(i){this.resize(i,this.height)}set height(i){this.resize(this.width,i)}constructor(i,t){this.ctx=(0,canvas_1.createCanvas)(i,t).getContext("2d")}rect(i,t,r,a,o,n){const e=this.ctx;if(a??=e.canvas.width-t,o??=e.canvas.height-r,n??=0,this.customProperties.rectAlign&&(t=__1.CanvasUtil.calculateRectAlignOrBaseline(t,a,this.customProperties.rectAlign)),this.customProperties.rectBaseline&&(r=__1.CanvasUtil.calculateRectAlignOrBaseline(r,o,this.customProperties.rectBaseline)),i===__1.FillOrStrokeOrClear.none)return e.roundRect(t,r,a,o,n);if(!n){i===__1.FillOrStrokeOrClear.fill&&e.fillRect(t,r,a,o),i===__1.FillOrStrokeOrClear.stroke&&e.strokeRect(t,r,a,o),i===__1.FillOrStrokeOrClear.clear&&e.clearRect(t,r,a,o);return}e.save(),e.beginPath(),e.roundRect(t,r,a,o,n),{[__1.FillOrStrokeOrClear.clear]:()=>(e.clip(),e.clearRect(t,r,a,o)),[__1.FillOrStrokeOrClear.fill]:()=>e.fill(),[__1.FillOrStrokeOrClear.stroke]:()=>e.stroke()}[i](),e.restore()}text(i,t,r,a,o,n,e,l,c){const s=this.ctx,u=s.font,d=Number.parseFloat(__1.fontRegex.exec(o)[4]),v=e?t.split(`
`):[t],b=(f,g,p,m)=>i===__1.FillOrStroke.fill?s.fillText(f,g,p,m):s.strokeText(f,g,p,m);let h=a;if(n??=void 0,s.font=o,e||l)for(const f of v)if(l){let g="";f.split(" ").forEach((p,m)=>{n&&s.measureText(g+p+" ").width>n&&m>0?(b(g,r,h,n),g=p+" ",h+=d+(c??0)):g+=p+" "}),b(g,r,h,n),h+=d+(c??0)}else b(f,r,h,n),h+=d+(c??0);else b(t,r,a,n);s.font=u}async drawImage(i,t,r,a,o,n){const e=this.ctx;if(i=await(0,canvas_1.loadImage)(i),a??=i.width,o??=i.height,this.customProperties.rectAlign&&(t=__1.CanvasUtil.calculateRectAlignOrBaseline(t,a,this.customProperties.rectAlign)),this.customProperties.rectBaseline&&(r=__1.CanvasUtil.calculateRectAlignOrBaseline(r,o,this.customProperties.rectBaseline)),!n)return e.drawImage(i,t,r,a,o);e.save(),e.beginPath(),e.roundRect(t,r,a,o,n),e.clip(),e.drawImage(i,t,r,a,o),e.restore()}drawProgressBar(i,t,r,a,o,n={}){const e=this.ctx;o=Math.min(o||0,100)/100;const l={style:n?.style??"#FFFFFF",background:{enabled:n?.background?.enabled??!0,style:n?.background?.style??"#000000",radius:n?.background?.radius,type:n?.background?.type??"fill",padding:n?.background?.padding??0},type:n?.type??"fill",radius:n?.radius,direction:n?.direction??"horizontal",clip:n?.clip,left:n?.left};this.customProperties.rectAlign&&(i=__1.CanvasUtil.calculateRectAlignOrBaseline(i,r,this.customProperties.rectAlign)),this.customProperties.rectBaseline&&(t=__1.CanvasUtil.calculateRectAlignOrBaseline(t,a,this.customProperties.rectBaseline)),l.background.enabled&&(l.background.type!=="clear"?(e.save(),e[`${l.background.type}Style`]=l.background.style,e.beginPath(),e.roundRect(i,t,r,a,l.background.radius),e[l.background.type](),e.restore()):this.rect(__1.FillOrStrokeOrClear.clear,i,t,r,a,l.background.radius)),l.background.padding&&(r=r-l.background.padding*2,a=a-l.background.padding*2,i=i+l.background.padding,t=t+ +l.background.padding);const c=Math.min(["horizontal","both"].includes(l.direction)?r*o:r,r),s=Math.min(["vertical","both"].includes(l.direction)?a*o:a,a);return l.type==="clear"?(this.rect(__1.FillOrStrokeOrClear.clear,i,t,c,s,l.radius),[i,t,r,a,c,s]):(e.save(),l.clip!==void 0&&(e.beginPath(),e.roundRect(i,t,r,a,l.clip),e.clip()),l.left&&(e.fillStyle=l.left,e.beginPath(),e.roundRect(i,t,r,a,l.radius),e.fill()),e[`${l.type}Style`]=l.style,e.beginPath(),e.roundRect(i,t,c,s,l.radius),e[l.type](),e.restore(),[i,t,r,a,c,s])}drawPieChart(i,t,r,a,o,n={}){const e=this.ctx,l={type:n.type??"fill",background:{enabled:n.background?.enabled??!0,style:n.background?.style??"#000000",radius:n.background?.radius,type:n.background?.type??"fill",padding:n.background?.padding??0},radius:n.radius??Math.min(r,a)/2};this.customProperties.rectAlign&&(i=__1.CanvasUtil.calculateRectAlignOrBaseline(i,r,this.customProperties.rectAlign)),this.customProperties.rectBaseline&&(t=__1.CanvasUtil.calculateRectAlignOrBaseline(t,a,this.customProperties.rectBaseline)),l.background.enabled&&(l.background.type!=="clear"?(e.save(),e[`${l.background.type}Style`]=l.background.style,e.beginPath(),e.roundRect(i,t,r,a,l.background.radius),e[l.background.type](),e.restore()):this.rect(__1.FillOrStrokeOrClear.clear,i,t,r,a,l.background.radius)),l.background.padding&&(r=r-l.background.padding*2,a=a-l.background.padding*2,i=i+l.background.padding,t=t+l.background.padding);const c=o.reduce((u,d)=>u+d.value,0);let s=0;for(const u of o){const d=s+u.value/c*Math.PI*2;e.save(),e.beginPath(),e.moveTo(i+r/2,t+a/2),e.arc(i+r/2,t+a/2,Math.min(r,a)/2,s,d),e.arc(i+r/2,t+a/2,l.radius??0,d,s,!0),e.lineTo(i+r/2,t+a/2),e.closePath(),e.fillStyle=u.style,e.fill(),e.restore(),s=d}}measureText(i,t){const r=this.ctx,a=r.fillStyle,o=r.font;r.fillStyle="#000000",r.font=t;const n=r.measureText(i);return r.fillStyle=a,r.font=o,n}filter(i,t,r){const a=this.ctx;t&&typeof t=="string"&&(t=__1.Filters[t]);const o=t===__1.Filters.grayscale||t===__1.Filters.sepia?"%":t===__1.Filters.blur?"px":"";if(i===__1.FilterMethod.add){if(!t||!r)throw new Error("No filter or value provided");const n=__1.CanvasUtil.parseFilters((a.filter==="none"?"":a.filter)+`${__1.Filters[t]}(${r+o})`);a.filter=n?.map(e=>e?.raw)?.join(" ")?.trim()||"none"}else if(i===__1.FilterMethod.set){if(!t||!r)throw new Error("No filter or value provided");a.filter=`${__1.Filters[t]}(${r+o})`}else if(i===__1.FilterMethod.remove){if(!t)throw new Error("No filter provided");const n=__1.CanvasUtil.parseFilters(a.filter),e=n.findIndex(l=>l?.filter===__1.Filters[t]);e!==-1&&n.splice(e,1),a.filter=n.length>0?n?.map(l=>l?.raw)?.join(" ")?.trim():"none"}else if(i===__1.FilterMethod.clear)a.filter="none";else{if(i===__1.FilterMethod.get)return a.filter;if(i===__1.FilterMethod.json)return __1.CanvasUtil.parseFilters(a.filter)}}rotate(i){const t=this.ctx,r=t.canvas.width/2,a=t.canvas.height/2;t.translate(r,a),t.rotate(i*Math.PI/180),t.translate(-r,-a)}trim(){let i=this.ctx,t=i.canvas,r=i.getImageData(0,0,t.width,t.height),a=r.data.length,o,n={top:t.height,left:t.width,right:0,bottom:0},e,l;for(o=0;o<a;o+=4)r.data[o+3]!==0&&(e=o/4%t.width,l=Math.floor(o/4/t.width),e<n.left&&(n.left=e),l<n.top&&(n.top=l),l>n.bottom&&(n.bottom=l),e>n.right&&(n.right=e));const c=n.bottom-n.top+1,s=n.right-n.left+1,u=i.getImageData(n.left,n.top,s,c);t.width=s,t.height=c,i.putImageData(u,0,0)}getPixels(i,t,r,a,o){const n=this.ctx;r??=n.canvas.width,a??=n.canvas.height;const e=n.getImageData(i,t,r,a).data;return o===__1.ColorDataType.Rgba?Array.from(e):(0,gifsx_1.rgbaToHex)(Uint8Array.from(e),!1,!0)}setPixels(i,t,r,a,o,n){const e=this.ctx;r??=e.canvas.width,a??=e.canvas.height;const l=e.createImageData(r,a);n!==__1.ColorDataType.Rgba?l.data.set(Uint8ClampedArray.from((0,gifsx_1.hexToRgba)(o))):l.data.set(Uint8ClampedArray.from(o)),e.putImageData(l,i,t)}resize(i,t){const r=this.ctx,a=r.getImageData(0,0,r.canvas.width,r.canvas.height);r.canvas.width=i,r.canvas.height=t,r.putImageData(a,0,0)}dataUrl(i){return this.ctx.canvas.toDataURL(i)}buffer(i){return i==="image/png"?this.ctx.canvas.toBuffer("image/png"):this.ctx.canvas.toBuffer(i)}}exports.CanvasBuilder=CanvasBuilder;
