"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CanvasBuilder=void 0;const canvas_1=require("@napi-rs/canvas"),__1=require(".."),gifsx_1=require("@gifsx/gifsx");class CanvasBuilder{ctx;util=__1.CanvasUtil;customProperties={};get width(){return this.ctx.canvas.width}get height(){return this.ctx.canvas.height}set width(s){this.resize(s,this.height)}set height(s){this.resize(this.width,s)}constructor(s,e){this.ctx=(0,canvas_1.createCanvas)(s,e).getContext("2d")}rect(s,e,r,a,n,l){const t=this.ctx;if(a??=t.canvas.width-e,n??=t.canvas.height-r,l??=0,this.customProperties.rectAlign&&(e=__1.CanvasUtil.calculateRectAlignOrBaseline(e,a,this.customProperties.rectAlign)),this.customProperties.rectBaseline&&(r=__1.CanvasUtil.calculateRectAlignOrBaseline(r,n,this.customProperties.rectBaseline)),s===__1.FillOrStrokeOrClear.none)return t.roundRect(e,r,a,n,l);if(!l){s===__1.FillOrStrokeOrClear.fill&&t.fillRect(e,r,a,n),s===__1.FillOrStrokeOrClear.stroke&&t.strokeRect(e,r,a,n),s===__1.FillOrStrokeOrClear.clear&&t.clearRect(e,r,a,n);return}t.save(),t.beginPath(),t.roundRect(e,r,a,n,l),{[__1.FillOrStrokeOrClear.clear]:()=>t.clearRect(e,r,a,n),[__1.FillOrStrokeOrClear.fill]:()=>t.fill(),[__1.FillOrStrokeOrClear.stroke]:()=>t.stroke()}[s](),t.restore()}text(s,e,r,a,n,l,t,i,o){const c=this.ctx,d=c.font,u=parseFloat(__1.fontRegex.exec(n)[4]),m=t?e.split(`
`):[e],k=(b,f,g,v)=>s===__1.FillOrStroke.fill?c.fillText(b,f,g,v):c.strokeText(b,f,g,v);let p=a;l??=void 0,c.font=n,t||i?m.forEach(b=>{if(i){let f="";b.split(" ").forEach((g,v)=>{l&&c.measureText(f+g+" ").width>l&&v>0?(k(f,r,p,l),f=g+" ",p+=u+(o??0)):f+=g+" "}),k(f,r,p,l),p+=u+(o??0)}else k(b,r,p,l),p+=u+(o??0)}):k(e,r,a,l),c.font=d}async drawImage(s,e,r,a,n,l){const t=this.ctx;if(s=await(0,canvas_1.loadImage)(s),a??=s.width,n??=s.height,this.customProperties.rectAlign&&(e=__1.CanvasUtil.calculateRectAlignOrBaseline(e,a,this.customProperties.rectAlign)),this.customProperties.rectBaseline&&(r=__1.CanvasUtil.calculateRectAlignOrBaseline(r,n,this.customProperties.rectBaseline)),!l)return t.drawImage(s,e,r,a,n);t.save(),t.beginPath(),t.roundRect(e,r,a,n,l),t.clip(),t.drawImage(s,e,r,a,n),t.restore()}drawProgressBar(s,e,r,a,n,l={}){const t=this.ctx;n=Math.min(n||0,100)/100;const i={style:l?.style??"#FFFFFF",background:{enabled:l?.background?.enabled??!0,style:l?.background?.style??"#000000",radius:l?.background?.radius,type:l?.background?.type??"fill",padding:l?.background?.padding??0},type:l?.type??"fill",radius:l?.radius,direction:l?.direction??"horizontal",clip:l?.clip,left:l?.left};this.customProperties.rectAlign&&(s=__1.CanvasUtil.calculateRectAlignOrBaseline(s,r,this.customProperties.rectAlign)),this.customProperties.rectBaseline&&(e=__1.CanvasUtil.calculateRectAlignOrBaseline(e,a,this.customProperties.rectBaseline)),i.background.enabled&&(i.background.type!=="clear"?(t.save(),t[`${i.background.type}Style`]=i.background.style,t.beginPath(),t.roundRect(s,e,r,a,i.background.radius),t[i.background.type](),t.restore()):this.rect(__1.FillOrStrokeOrClear.clear,s,e,r,a,i.background.radius)),i.background.padding&&(r=r-i.background.padding*2,a=a-i.background.padding*2,s=s+i.background.padding,e=e+ +i.background.padding);const o=Math.min(["horizontal","both"].includes(i.direction)?r*n:r,r),c=Math.min(["vertical","both"].includes(i.direction)?a*n:a,a);return i.type==="clear"?(this.rect(__1.FillOrStrokeOrClear.clear,s,e,o,c,i.radius),[s,e,r,a,o,c]):(t.save(),i.clip!==void 0&&(t.beginPath(),t.roundRect(s,e,r,a,i.clip),t.clip()),i.left&&(t.fillStyle=i.left,t.beginPath(),t.roundRect(s,e,r,a,i.radius),t.fill()),t[`${i.type}Style`]=i.style,t.beginPath(),t.roundRect(s,e,o,c,i.radius),t[i.type](),t.restore(),[s,e,r,a,o,c])}drawPieChart(s,e,r,a,n,l={}){const t=this.ctx,i={type:l.type??"fill",background:{enabled:l.background?.enabled??!0,style:l.background?.style??"#000000",radius:l.background?.radius,type:l.background?.type??"fill",padding:l.background?.padding??0},radius:l.radius??Math.min(r,a)/2};this.customProperties.rectAlign&&(s=__1.CanvasUtil.calculateRectAlignOrBaseline(s,r,this.customProperties.rectAlign)),this.customProperties.rectBaseline&&(e=__1.CanvasUtil.calculateRectAlignOrBaseline(e,a,this.customProperties.rectBaseline)),i.background.enabled&&(i.background.type!=="clear"?(t.save(),t[`${i.background.type}Style`]=i.background.style,t.beginPath(),t.roundRect(s,e,r,a,i.background.radius),t[i.background.type](),t.restore()):this.rect(__1.FillOrStrokeOrClear.clear,s,e,r,a,i.background.radius)),i.background.padding&&(r=r-i.background.padding*2,a=a-i.background.padding*2,s=s+i.background.padding,e=e+i.background.padding);const o=n.reduce((d,u)=>d+u.value,0);let c=0;n.forEach(d=>{const u=c+d.value/o*Math.PI*2;t.save(),t.beginPath(),t.moveTo(s+r/2,e+a/2),t.arc(s+r/2,e+a/2,Math.min(r,a)/2,c,u),t.arc(s+r/2,e+a/2,i.radius??0,u,c,!0),t.lineTo(s+r/2,e+a/2),t.closePath(),t.fillStyle=d.style,t.fill(),t.restore(),c=u})}measureText(s,e){const r=this.ctx,a=r.fillStyle,n=r.font;r.fillStyle="#000000",r.font=e;const l=r.measureText(s);return r.fillStyle=a,r.font=n,l}filter(s,e,r){const a=this.ctx;e&&typeof e=="string"&&(e=__1.Filters[e]);const n=e===__1.Filters.grayscale||e===__1.Filters.sepia?"%":e===__1.Filters.blur?"px":"";if(s===__1.FilterMethod.add){if(!e||!r)return;a.filter=__1.CanvasUtil.parseFilters((a.filter==="none"?"":a.filter)+`${__1.Filters[e]}(${r+n})`)?.map(l=>l?.raw)?.join(" ")?.trim()}else if(s===__1.FilterMethod.set){if(!e||!r)return;a.filter=`${__1.Filters[e]}(${r+n})`}else if(s===__1.FilterMethod.remove){if(!e)return;let l=__1.CanvasUtil.parseFilters(a.filter);const t=l.findIndex(i=>i?.filter===__1.Filters[e]);t!==-1&&l.splice(t,1),a.filter=l.length>0?l?.map(i=>i?.raw)?.join(" ")?.trim():"none"}else if(s===__1.FilterMethod.clear)a.filter="none";else{if(s===__1.FilterMethod.get)return a.filter;if(s===__1.FilterMethod.json)return __1.CanvasUtil.parseFilters(a.filter)}}rotate(s){const e=this.ctx,r=e.canvas.width/2,a=e.canvas.height/2;e.translate(r,a),e.rotate(s*Math.PI/180),e.translate(-r,-a)}trim(){let s=this.ctx,e=s.canvas,r=s.getImageData(0,0,e.width,e.height),a=r.data.length,n,l={top:e.height,left:e.width,right:0,bottom:0},t,i;for(n=0;n<a;n+=4)r.data[n+3]!==0&&(t=n/4%e.width,i=Math.floor(n/4/e.width),t<l.left&&(l.left=t),i<l.top&&(l.top=i),i>l.bottom&&(l.bottom=i),t>l.right&&(l.right=t));const o=l.bottom-l.top+1,c=l.right-l.left+1,d=s.getImageData(l.left,l.top,c,o);e.width=c,e.height=o,s.putImageData(d,0,0)}getPixels(s,e,r,a,n){const l=this.ctx;r??=l.canvas.width,a??=l.canvas.height;const t=l.getImageData(s,e,r,a).data;return n===__1.ColorDataType.Rgba?Array.from(t):(0,gifsx_1.rgbaToHex)(Uint8Array.from(t),!1,!0)}setPixels(s,e,r,a,n,l){const t=this.ctx;r??=t.canvas.width,a??=t.canvas.height;const i=t.createImageData(r,a);l!==__1.ColorDataType.Rgba?i.data.set(Uint8ClampedArray.from((0,gifsx_1.hexToRgba)(n))):i.data.set(Uint8ClampedArray.from(n)),t.putImageData(i,s,e)}resize(s,e){const r=this.ctx,a=r.getImageData(0,0,r.canvas.width,r.canvas.height);r.canvas.width=s,r.canvas.height=e,r.putImageData(a,0,0)}get dataUrl(){return this.ctx.canvas.toDataURL("image/png")}get buffer(){return this.ctx.canvas.toBuffer("image/png")}}exports.CanvasBuilder=CanvasBuilder;
