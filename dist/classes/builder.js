"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CanvasBuilder=void 0;const canvas_1=require("@napi-rs/canvas"),__1=require(".."),gifsx_1=require("@gifsx/gifsx");class CanvasBuilder{ctx;util=__1.CanvasUtil;customProperties={};get width(){return this.ctx.canvas.width}get height(){return this.ctx.canvas.height}set width(a){this.resize(a,this.height)}set height(a){this.resize(this.width,a)}constructor(a,e){this.ctx=(0,canvas_1.createCanvas)(a,e).getContext("2d")}rect(a,e,r,s,i,l){const t=this.ctx;if(s??=t.canvas.width-e,i??=t.canvas.height-r,l??=0,this.customProperties.rectAlign&&(e=__1.CanvasUtil.calculateRectAlignOrBaseline(e,s,this.customProperties.rectAlign)),this.customProperties.rectBaseline&&(r=__1.CanvasUtil.calculateRectAlignOrBaseline(r,i,this.customProperties.rectBaseline)),a===__1.FillOrStrokeOrClear.none)return t.roundRect(e,r,s,i,l);if(!l){a===__1.FillOrStrokeOrClear.fill&&t.fillRect(e,r,s,i),a===__1.FillOrStrokeOrClear.stroke&&t.strokeRect(e,r,s,i),a===__1.FillOrStrokeOrClear.clear&&t.clearRect(e,r,s,i);return}t.save(),t.beginPath(),t.roundRect(e,r,s,i,l),{[__1.FillOrStrokeOrClear.clear]:()=>(t.clip(),t.clearRect(e,r,s,i)),[__1.FillOrStrokeOrClear.fill]:()=>t.fill(),[__1.FillOrStrokeOrClear.stroke]:()=>t.stroke()}[a](),t.restore()}text(a,e,r,s,i,l,t,n,o){const c=this.ctx,d=c.font,u=Number.parseFloat(__1.fontRegex.exec(i)[4]),m=t?e.split(`
`):[e],k=(b,f,g,v)=>a===__1.FillOrStroke.fill?c.fillText(b,f,g,v):c.strokeText(b,f,g,v);let p=s;if(l??=void 0,c.font=i,t||n)for(const b of m)if(n){let f="";b.split(" ").forEach((g,v)=>{l&&c.measureText(f+g+" ").width>l&&v>0?(k(f,r,p,l),f=g+" ",p+=u+(o??0)):f+=g+" "}),k(f,r,p,l),p+=u+(o??0)}else k(b,r,p,l),p+=u+(o??0);else k(e,r,s,l);c.font=d}async drawImage(a,e,r,s,i,l){const t=this.ctx;if(a=await(0,canvas_1.loadImage)(a),s??=a.width,i??=a.height,this.customProperties.rectAlign&&(e=__1.CanvasUtil.calculateRectAlignOrBaseline(e,s,this.customProperties.rectAlign)),this.customProperties.rectBaseline&&(r=__1.CanvasUtil.calculateRectAlignOrBaseline(r,i,this.customProperties.rectBaseline)),!l)return t.drawImage(a,e,r,s,i);t.save(),t.beginPath(),t.roundRect(e,r,s,i,l),t.clip(),t.drawImage(a,e,r,s,i),t.restore()}drawProgressBar(a,e,r,s,i,l={}){const t=this.ctx;i=Math.min(i||0,100)/100;const n={style:l?.style??"#FFFFFF",background:{enabled:l?.background?.enabled??!0,style:l?.background?.style??"#000000",radius:l?.background?.radius,type:l?.background?.type??"fill",padding:l?.background?.padding??0},type:l?.type??"fill",radius:l?.radius,direction:l?.direction??"horizontal",clip:l?.clip,left:l?.left};this.customProperties.rectAlign&&(a=__1.CanvasUtil.calculateRectAlignOrBaseline(a,r,this.customProperties.rectAlign)),this.customProperties.rectBaseline&&(e=__1.CanvasUtil.calculateRectAlignOrBaseline(e,s,this.customProperties.rectBaseline)),n.background.enabled&&(n.background.type!=="clear"?(t.save(),t[`${n.background.type}Style`]=n.background.style,t.beginPath(),t.roundRect(a,e,r,s,n.background.radius),t[n.background.type](),t.restore()):this.rect(__1.FillOrStrokeOrClear.clear,a,e,r,s,n.background.radius)),n.background.padding&&(r=r-n.background.padding*2,s=s-n.background.padding*2,a=a+n.background.padding,e=e+ +n.background.padding);const o=Math.min(["horizontal","both"].includes(n.direction)?r*i:r,r),c=Math.min(["vertical","both"].includes(n.direction)?s*i:s,s);return n.type==="clear"?(this.rect(__1.FillOrStrokeOrClear.clear,a,e,o,c,n.radius),[a,e,r,s,o,c]):(t.save(),n.clip!==void 0&&(t.beginPath(),t.roundRect(a,e,r,s,n.clip),t.clip()),n.left&&(t.fillStyle=n.left,t.beginPath(),t.roundRect(a,e,r,s,n.radius),t.fill()),t[`${n.type}Style`]=n.style,t.beginPath(),t.roundRect(a,e,o,c,n.radius),t[n.type](),t.restore(),[a,e,r,s,o,c])}drawPieChart(a,e,r,s,i,l={}){const t=this.ctx,n={type:l.type??"fill",background:{enabled:l.background?.enabled??!0,style:l.background?.style??"#000000",radius:l.background?.radius,type:l.background?.type??"fill",padding:l.background?.padding??0},radius:l.radius??Math.min(r,s)/2};this.customProperties.rectAlign&&(a=__1.CanvasUtil.calculateRectAlignOrBaseline(a,r,this.customProperties.rectAlign)),this.customProperties.rectBaseline&&(e=__1.CanvasUtil.calculateRectAlignOrBaseline(e,s,this.customProperties.rectBaseline)),n.background.enabled&&(n.background.type!=="clear"?(t.save(),t[`${n.background.type}Style`]=n.background.style,t.beginPath(),t.roundRect(a,e,r,s,n.background.radius),t[n.background.type](),t.restore()):this.rect(__1.FillOrStrokeOrClear.clear,a,e,r,s,n.background.radius)),n.background.padding&&(r=r-n.background.padding*2,s=s-n.background.padding*2,a=a+n.background.padding,e=e+n.background.padding);const o=i.reduce((d,u)=>d+u.value,0);let c=0;for(const d of i){const u=c+d.value/o*Math.PI*2;t.save(),t.beginPath(),t.moveTo(a+r/2,e+s/2),t.arc(a+r/2,e+s/2,Math.min(r,s)/2,c,u),t.arc(a+r/2,e+s/2,n.radius??0,u,c,!0),t.lineTo(a+r/2,e+s/2),t.closePath(),t.fillStyle=d.style,t.fill(),t.restore(),c=u}}measureText(a,e){const r=this.ctx,s=r.fillStyle,i=r.font;r.fillStyle="#000000",r.font=e;const l=r.measureText(a);return r.fillStyle=s,r.font=i,l}filter(a,e,r){const s=this.ctx;e&&typeof e=="string"&&(e=__1.Filters[e]);const i=e===__1.Filters.grayscale||e===__1.Filters.sepia?"%":e===__1.Filters.blur?"px":"";if(a===__1.FilterMethod.add){if(!e||!r)throw new Error("No filter or value provided");const l=__1.CanvasUtil.parseFilters((s.filter==="none"?"":s.filter)+`${__1.Filters[e]}(${r+i})`);s.filter=l?.map(t=>t?.raw)?.join(" ")?.trim()||"none"}else if(a===__1.FilterMethod.set){if(!e||!r)throw new Error("No filter or value provided");s.filter=`${__1.Filters[e]}(${r+i})`}else if(a===__1.FilterMethod.remove){if(!e)throw new Error("No filter provided");const l=__1.CanvasUtil.parseFilters(s.filter),t=l.findIndex(n=>n?.filter===__1.Filters[e]);t!==-1&&l.splice(t,1),s.filter=l.length>0?l?.map(n=>n?.raw)?.join(" ")?.trim():"none"}else if(a===__1.FilterMethod.clear)s.filter="none";else{if(a===__1.FilterMethod.get)return s.filter;if(a===__1.FilterMethod.json)return __1.CanvasUtil.parseFilters(s.filter)}}rotate(a){const e=this.ctx,r=e.canvas.width/2,s=e.canvas.height/2;e.translate(r,s),e.rotate(a*Math.PI/180),e.translate(-r,-s)}trim(){let a=this.ctx,e=a.canvas,r=a.getImageData(0,0,e.width,e.height),s=r.data.length,i,l={top:e.height,left:e.width,right:0,bottom:0},t,n;for(i=0;i<s;i+=4)r.data[i+3]!==0&&(t=i/4%e.width,n=Math.floor(i/4/e.width),t<l.left&&(l.left=t),n<l.top&&(l.top=n),n>l.bottom&&(l.bottom=n),t>l.right&&(l.right=t));const o=l.bottom-l.top+1,c=l.right-l.left+1,d=a.getImageData(l.left,l.top,c,o);e.width=c,e.height=o,a.putImageData(d,0,0)}getPixels(a,e,r,s,i){const l=this.ctx;r??=l.canvas.width,s??=l.canvas.height;const t=l.getImageData(a,e,r,s).data;return i===__1.ColorDataType.Rgba?Array.from(t):(0,gifsx_1.rgbaToHex)(Uint8Array.from(t),!1,!0)}setPixels(a,e,r,s,i,l){const t=this.ctx;r??=t.canvas.width,s??=t.canvas.height;const n=t.createImageData(r,s);l!==__1.ColorDataType.Rgba?n.data.set(Uint8ClampedArray.from((0,gifsx_1.hexToRgba)(i))):n.data.set(Uint8ClampedArray.from(i)),t.putImageData(n,a,e)}resize(a,e){const r=this.ctx,s=r.getImageData(0,0,r.canvas.width,r.canvas.height);r.canvas.width=a,r.canvas.height=e,r.putImageData(s,0,0)}dataUrl(a){return this.ctx.canvas.toDataURL(a)}buffer(a){return a==="image/png"?this.ctx.canvas.toBuffer("image/png"):this.ctx.canvas.toBuffer(a)}}exports.CanvasBuilder=CanvasBuilder;
