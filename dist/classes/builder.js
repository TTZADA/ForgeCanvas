"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CanvasBuilder=void 0;const canvas_1=require("@napi-rs/canvas"),__1=require(".."),gifsx_1=require("@gifsx/gifsx");class CanvasBuilder{ctx;util=__1.CanvasUtil;customProperties={};get width(){return this.ctx.canvas.width}get height(){return this.ctx.canvas.height}set width(a){this.resize(a,this.height)}set height(a){this.resize(this.width,a)}constructor(a,e){this.ctx=(0,canvas_1.createCanvas)(a,e).getContext("2d")}rect(a,e,r,s,n,l){const t=this.ctx;if(s??=t.canvas.width-e,n??=t.canvas.height-r,l??=0,this.customProperties.rectAlign&&(e=__1.CanvasUtil.calculateRectAlignOrBaseline(e,s,this.customProperties.rectAlign)),this.customProperties.rectBaseline&&(r=__1.CanvasUtil.calculateRectAlignOrBaseline(r,n,this.customProperties.rectBaseline)),a===__1.FillOrStrokeOrClear.none)return t.roundRect(e,r,s,n,l);if(!l){a===__1.FillOrStrokeOrClear.fill&&t.fillRect(e,r,s,n),a===__1.FillOrStrokeOrClear.stroke&&t.strokeRect(e,r,s,n),a===__1.FillOrStrokeOrClear.clear&&t.clearRect(e,r,s,n);return}t.save(),t.beginPath(),t.roundRect(e,r,s,n,l),{[__1.FillOrStrokeOrClear.clear]:()=>(t.clip(),t.clearRect(e,r,s,n)),[__1.FillOrStrokeOrClear.fill]:()=>t.fill(),[__1.FillOrStrokeOrClear.stroke]:()=>t.stroke()}[a](),t.restore()}text(a,e,r,s,n,l,t,i,o){const c=this.ctx,d=c.font,u=parseFloat(__1.fontRegex.exec(n)[4]),m=t?e.split(`
`):[e],k=(b,f,g,v)=>a===__1.FillOrStroke.fill?c.fillText(b,f,g,v):c.strokeText(b,f,g,v);let p=s;l??=void 0,c.font=n,t||i?m.forEach(b=>{if(i){let f="";b.split(" ").forEach((g,v)=>{l&&c.measureText(f+g+" ").width>l&&v>0?(k(f,r,p,l),f=g+" ",p+=u+(o??0)):f+=g+" "}),k(f,r,p,l),p+=u+(o??0)}else k(b,r,p,l),p+=u+(o??0)}):k(e,r,s,l),c.font=d}async drawImage(a,e,r,s,n,l){const t=this.ctx;if(a=await(0,canvas_1.loadImage)(a),s??=a.width,n??=a.height,this.customProperties.rectAlign&&(e=__1.CanvasUtil.calculateRectAlignOrBaseline(e,s,this.customProperties.rectAlign)),this.customProperties.rectBaseline&&(r=__1.CanvasUtil.calculateRectAlignOrBaseline(r,n,this.customProperties.rectBaseline)),!l)return t.drawImage(a,e,r,s,n);t.save(),t.beginPath(),t.roundRect(e,r,s,n,l),t.clip(),t.drawImage(a,e,r,s,n),t.restore()}drawProgressBar(a,e,r,s,n,l={}){const t=this.ctx;n=Math.min(n||0,100)/100;const i={style:l?.style??"#FFFFFF",background:{enabled:l?.background?.enabled??!0,style:l?.background?.style??"#000000",radius:l?.background?.radius,type:l?.background?.type??"fill",padding:l?.background?.padding??0},type:l?.type??"fill",radius:l?.radius,direction:l?.direction??"horizontal",clip:l?.clip,left:l?.left};this.customProperties.rectAlign&&(a=__1.CanvasUtil.calculateRectAlignOrBaseline(a,r,this.customProperties.rectAlign)),this.customProperties.rectBaseline&&(e=__1.CanvasUtil.calculateRectAlignOrBaseline(e,s,this.customProperties.rectBaseline)),i.background.enabled&&(i.background.type!=="clear"?(t.save(),t[`${i.background.type}Style`]=i.background.style,t.beginPath(),t.roundRect(a,e,r,s,i.background.radius),t[i.background.type](),t.restore()):this.rect(__1.FillOrStrokeOrClear.clear,a,e,r,s,i.background.radius)),i.background.padding&&(r=r-i.background.padding*2,s=s-i.background.padding*2,a=a+i.background.padding,e=e+ +i.background.padding);const o=Math.min(["horizontal","both"].includes(i.direction)?r*n:r,r),c=Math.min(["vertical","both"].includes(i.direction)?s*n:s,s);return i.type==="clear"?(this.rect(__1.FillOrStrokeOrClear.clear,a,e,o,c,i.radius),[a,e,r,s,o,c]):(t.save(),i.clip!==void 0&&(t.beginPath(),t.roundRect(a,e,r,s,i.clip),t.clip()),i.left&&(t.fillStyle=i.left,t.beginPath(),t.roundRect(a,e,r,s,i.radius),t.fill()),t[`${i.type}Style`]=i.style,t.beginPath(),t.roundRect(a,e,o,c,i.radius),t[i.type](),t.restore(),[a,e,r,s,o,c])}drawPieChart(a,e,r,s,n,l={}){const t=this.ctx,i={type:l.type??"fill",background:{enabled:l.background?.enabled??!0,style:l.background?.style??"#000000",radius:l.background?.radius,type:l.background?.type??"fill",padding:l.background?.padding??0},radius:l.radius??Math.min(r,s)/2};this.customProperties.rectAlign&&(a=__1.CanvasUtil.calculateRectAlignOrBaseline(a,r,this.customProperties.rectAlign)),this.customProperties.rectBaseline&&(e=__1.CanvasUtil.calculateRectAlignOrBaseline(e,s,this.customProperties.rectBaseline)),i.background.enabled&&(i.background.type!=="clear"?(t.save(),t[`${i.background.type}Style`]=i.background.style,t.beginPath(),t.roundRect(a,e,r,s,i.background.radius),t[i.background.type](),t.restore()):this.rect(__1.FillOrStrokeOrClear.clear,a,e,r,s,i.background.radius)),i.background.padding&&(r=r-i.background.padding*2,s=s-i.background.padding*2,a=a+i.background.padding,e=e+i.background.padding);const o=n.reduce((d,u)=>d+u.value,0);let c=0;n.forEach(d=>{const u=c+d.value/o*Math.PI*2;t.save(),t.beginPath(),t.moveTo(a+r/2,e+s/2),t.arc(a+r/2,e+s/2,Math.min(r,s)/2,c,u),t.arc(a+r/2,e+s/2,i.radius??0,u,c,!0),t.lineTo(a+r/2,e+s/2),t.closePath(),t.fillStyle=d.style,t.fill(),t.restore(),c=u})}measureText(a,e){const r=this.ctx,s=r.fillStyle,n=r.font;r.fillStyle="#000000",r.font=e;const l=r.measureText(a);return r.fillStyle=s,r.font=n,l}filter(a,e,r){const s=this.ctx;e&&typeof e=="string"&&(e=__1.Filters[e]);const n=e===__1.Filters.grayscale||e===__1.Filters.sepia?"%":e===__1.Filters.blur?"px":"";if(a===__1.FilterMethod.add){if(!e||!r)throw new Error("No filter or value provided");const l=__1.CanvasUtil.parseFilters((s.filter==="none"?"":s.filter)+`${__1.Filters[e]}(${r+n})`);s.filter=l?.map(t=>t?.raw)?.join(" ")?.trim()||"none"}else if(a===__1.FilterMethod.set){if(!e||!r)throw new Error("No filter or value provided");s.filter=`${__1.Filters[e]}(${r+n})`}else if(a===__1.FilterMethod.remove){if(!e)throw new Error("No filter provided");let l=__1.CanvasUtil.parseFilters(s.filter);const t=l.findIndex(i=>i?.filter===__1.Filters[e]);t!==-1&&l.splice(t,1),s.filter=l.length>0?l?.map(i=>i?.raw)?.join(" ")?.trim():"none"}else if(a===__1.FilterMethod.clear)s.filter="none";else{if(a===__1.FilterMethod.get)return s.filter;if(a===__1.FilterMethod.json)return __1.CanvasUtil.parseFilters(s.filter)}}rotate(a){const e=this.ctx,r=e.canvas.width/2,s=e.canvas.height/2;e.translate(r,s),e.rotate(a*Math.PI/180),e.translate(-r,-s)}trim(){let a=this.ctx,e=a.canvas,r=a.getImageData(0,0,e.width,e.height),s=r.data.length,n,l={top:e.height,left:e.width,right:0,bottom:0},t,i;for(n=0;n<s;n+=4)r.data[n+3]!==0&&(t=n/4%e.width,i=Math.floor(n/4/e.width),t<l.left&&(l.left=t),i<l.top&&(l.top=i),i>l.bottom&&(l.bottom=i),t>l.right&&(l.right=t));const o=l.bottom-l.top+1,c=l.right-l.left+1,d=a.getImageData(l.left,l.top,c,o);e.width=c,e.height=o,a.putImageData(d,0,0)}getPixels(a,e,r,s,n){const l=this.ctx;r??=l.canvas.width,s??=l.canvas.height;const t=l.getImageData(a,e,r,s).data;return n===__1.ColorDataType.Rgba?Array.from(t):(0,gifsx_1.rgbaToHex)(Uint8Array.from(t),!1,!0)}setPixels(a,e,r,s,n,l){const t=this.ctx;r??=t.canvas.width,s??=t.canvas.height;const i=t.createImageData(r,s);l!==__1.ColorDataType.Rgba?i.data.set(Uint8ClampedArray.from((0,gifsx_1.hexToRgba)(n))):i.data.set(Uint8ClampedArray.from(n)),t.putImageData(i,a,e)}resize(a,e){const r=this.ctx,s=r.getImageData(0,0,r.canvas.width,r.canvas.height);r.canvas.width=a,r.canvas.height=e,r.putImageData(s,0,0)}dataUrl(a){return this.ctx.canvas.toDataURL(a)}buffer(a){return a==="image/png"?this.ctx.canvas.toBuffer("image/png"):this.ctx.canvas.toBuffer(a)}}exports.CanvasBuilder=CanvasBuilder;
